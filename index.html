<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surprise üíñ</title>

  <style>
    /* =========================
       Base & Layout
    ========================== */
    :root{
      --bg1:#ffe6f2;
      --bg2:#fff7fb;
      --card:#ffffffcc;
      --text:#1f1f1f;
      --accent:#ff3d88;
      --accent2:#7c3aed;
      --shadow: 0 20px 60px rgba(0,0,0,.12);
      --radius: 26px;
    }

    *{ box-sizing:border-box; }

    html, body{ overflow-x: hidden; }

    body{
      margin:0;
      min-height:100vh;
      width:100%;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 20% 15%, #ffd1e6 0%, transparent 55%),
        radial-gradient(900px 600px at 85% 80%, #d7c7ff 0%, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-y:auto;
      overflow-x:hidden;
      position:relative;
    }

    .wrap{
      min-height: 100vh;     /* fallback */
      min-height: 100svh;    /* iOS */
      display:flex;
      width: min(420px, 92vw);
      padding: 18px;
      margin: 0 auto;
      position: relative;
      z-index: 2; /* au-dessus des d√©cors */
    }

    .card{
      margin:auto;
      max-width:100%;
      overflow-x:hidden;
      position:relative;
      padding: 22px 20px 18px;
      border-radius: var(--radius);
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.65);
      transform: translateY(6px);
      animation: pop .45s ease-out both;
    }

    .card .img {
      margin-bottom: 12px;
    }

    @keyframes pop{
      from { opacity:0; transform: translateY(16px) scale(.98); }
      to   { opacity:1; transform: translateY(6px)  scale(1); }
    }

    /* =========================
       D√©cors (bulles)
    ========================== */
    .blob{
      position: fixed; /* n‚Äôaffecte pas la hauteur scrollable */
      inset: auto;
      width:240px; height:240px;
      opacity:.18;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, var(--accent), transparent 65%),
        radial-gradient(circle at 70% 70%, var(--accent2), transparent 60%);
      animation: float 10s ease-in-out infinite;
      pointer-events:none;
      z-index: 0;
    }
    .blob.b1{ top:-60px; left:-60px; animation-duration: 12s; }
    .blob.b2{ bottom:-80px; right:-80px; animation-duration: 14s; }

    @keyframes float{
      0%,100% { transform: translate(0,0) scale(1); }
      50%     { transform: translate(18px,-14px) scale(1.04); }
    }

    /* =========================
       UI
    ========================== */
    .ribbon{
      position:absolute;
      top: 14px; right: -42px;
      transform: rotate(35deg);
      background: rgba(124,58,237,.14);
      border: 1px solid rgba(124,58,237,.20);
      padding: 6px 56px;
      font-weight: 800;
      font-size: 12px;
      color: #3b1a93;
      z-index: 1;
    }

    .top{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 61, 136, .12);
      border: 1px solid rgba(255, 61, 136, .20);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .heart{
      --s: 0.65em;
      width: var(--s);
      height: var(--s);
      display: inline-block;
      flex: 0 0 auto;
      position: relative;
      background: var(--accent);
      border-radius: calc(var(--s) * 0.25);
      transform-origin: center;
      will-change: transform;
      transform: rotate(45deg) translateZ(0);
      animation: beat 1.2s ease-in-out infinite;
    }
    .heart:before, .heart:after{
      content:"";
      position:absolute;
      width: var(--s);
      height: var(--s);
      background: var(--accent);
      border-radius: 50%;
    }
    .heart:before{ left: calc(var(--s) * -0.5); top: 0; }
    .heart:after { left: 0; top: calc(var(--s) * -0.5); }

    @keyframes beat{
      0%,100% { transform: rotate(45deg) scale(1) translateZ(0); }
      50%     { transform: rotate(45deg) scale(1.25) translateZ(0); }
    }

    h1{
      font-size: 20px;
      margin: 0 0 8px;
      line-height:1.2;
      position: relative;
      z-index: 2;
    }

    .subtitle{
      margin:0 0 14px;
      opacity:.75;
      font-size: 13px;
      position: relative;
      z-index: 2;
    }

    .content{
      margin-top: 10px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.05);
      position: relative;
      z-index: 2;
    }

    .msg{
      font-size: 18px;
      line-height: 1.35;
      margin: 0;
    }

    .img{
      max-width: 100%;
      height: auto;
      border-radius: 16px;
      display:block;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      text-decoration:none;
      font-weight: 800;
      font-size: 15px;
      color:white;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(255,61,136,.25);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px); }

    .small{
      margin: 12px 0 0;
      font-size: 12px;
      opacity: .65;
      text-align:center;
      position: relative;
      z-index: 2;
    }

    .big-emoji {
      font-size: 120px;   /* ‚Üê augmente ici */
      line-height: 1;
      margin: 16px 0;
    }
    .big-emoji {
      animation: pop 0.3s ease-out;
    }

    .animal-label {
      font-size: 12px;
      opacity: 0.7;
    }

    @keyframes pop {
      from { transform: scale(0.6); }
      to   { transform: scale(1); }
    }

    .teleport-value {
      font-size: 22px;
      margin: 8px 0 12px;
      transition: transform 0.15s ease;
    }

    /* =========================
       Quiz / boutons
    ========================== */
    .quiz-btn{
      display:block;
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight: 800;
      text-align:left;
      margin-top: 10px;
    }
    .quiz-btn:hover{ filter: brightness(0.98); }
    .quiz-progress{ font-size: 12px; opacity:.7; margin: 6px 0 0; }
    .quiz-score{ font-size: 14px; opacity:.8; margin: 10px 0 0; }

    /* =========================
       Effets (disco / glitch)
    ========================== */
    body.disco .card{ animation: disco 0.22s infinite alternate; }
    @keyframes disco{
      from{ transform: translateY(6px) rotate(-0.6deg); }
      to  { transform: translateY(6px) rotate( 0.6deg); }
    }

    .glitch{
      text-shadow: 1px 0 rgba(255,61,136,.55), -1px 0 rgba(124,58,237,.55);
      animation: glitch 0.7s infinite;
    }
    @keyframes glitch{
      0%,100%{ transform: translateX(0); }
      50%    { transform: translateX(1px); }
    }

    /* =========================
     Effets (quiz image)
    ========================== */
    .grid-choices {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
    }

    .choice-img {
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 6px;
    background: #fff;
    }

    .choice-img img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 8px;
    }

    .choice-img span {
    display: block;
    margin-top: 6px;
    font-size: 14px;
    }

    /* =========================
       No√´l (neige)
    ========================== */
    .snow{ position: fixed; inset: 0; pointer-events:none; z-index:1; }

    body.xmas::before,
    body.xmas::after,
    body.xmas .snow{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background-repeat: repeat;
      will-change: transform;
    }

    body.xmas::before{
      opacity: .95;
      background-size: 90px 90px;
      background-image:
        radial-gradient(circle, #fff 3.6px, transparent 3.7px),
        radial-gradient(circle, #fff 3.0px, transparent 3.1px),
        radial-gradient(circle, #fff 2.4px, transparent 2.5px);
      background-position: 40px 30px, 120px 150px, 160px 70px;
      animation: snowFast 8s linear infinite;
    }

    body.xmas::after{
      opacity: .75;
      background-size: 130px 130px;
      background-image:
        radial-gradient(circle, #fff 3.6px, transparent 3.7px),
        radial-gradient(circle, #fff 3.0px, transparent 3.1px),
        radial-gradient(circle, #fff 2.4px, transparent 2.5px);
      background-position: 40px 30px, 120px 150px, 160px 70px;
      animation: snowMedium 14s linear infinite;
    }

    body.xmas .snow{
      opacity: .6;
      background-size: 180px 180px;
      background-image:
        radial-gradient(circle, #fff 3.6px, transparent 3.7px),
        radial-gradient(circle, #fff 3.0px, transparent 3.1px),
        radial-gradient(circle, #fff 2.4px, transparent 2.5px);
      background-position: 40px 30px, 120px 150px, 160px 70px;
      animation: snowSlow 22s linear infinite;
    }

    @keyframes snowFast{   from{ transform: translateY(-15%);} to{ transform: translateY(15%);} }
    @keyframes snowMedium{ from{ transform: translateY(-15%) translateX(-2%);} to{ transform: translateY(15%) translateX(2%);} }
    @keyframes snowSlow{   from{ transform: translateY(-15%) translateX( 2%);} to{ transform: translateY(15%) translateX(-2%);} }

    @media (prefers-reduced-motion: reduce){
      body.xmas::before, body.xmas::after, body.xmas .snow{ animation:none; }
    }
  </style>
</head>

<body>
  <!-- D√©cors -->
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="snow" aria-hidden="true"></div>

  <!-- Dev warning -->
  <div id="dev-warning" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:#ff3d88;color:#fff;padding:10px 0;text-align:center;font-weight:700;letter-spacing:.5px;font-size:14px;box-shadow:0 2px 12px rgba(0,0,0,.08);">
    ‚ö†Ô∏è Mode d√©veloppement actif ‚Äì Ne pas partager ce lien publiquement.
  </div>

  <div class="wrap">
    <div class="card" id="card">
      <div class="ribbon" id="ribbon">Pour Lily üíñ</div>
      <div class="top">
        <span class="badge"><span class="heart"></span> Surprise du c≈ìur</span>
      </div>

      <h1 id="title">Une petite surprise üíù</h1>

      <div class="content" id="content"></div>

      <p class="small">Ton porte-cl√© vient d‚Äôouvrir une surprise üéâ<br>Scanne √† nouveau pour en d√©couvrir d'autres au fil des heures ‚ú®</p>
    </div>
  </div>

<script>
/* ==========================================================
   1) CONFIG
========================================================== */

// ‚öôÔ∏è Sel pour le choix "par heure"
const SALT = "mon-sel-secret-123";
// =============== DEV MODE HELPERS ===============
function isDev() {
  return (
    /localhost|127\.0\.0\.1/.test(location.hostname) ||
    location.search.includes("dev") ||
    location.hash.includes("dev")
  );
}

function ensureDevBanner() {
  if (!isDev()) return;
  const el = document.getElementById("dev-warning");
  if (el) el.style.display = "block";
}

function ensureDevOverlay() {
  if (!isDev()) return null;
  let el = document.getElementById("dev-overlay");
  if (!el) {
    el = document.createElement("div");
    el.id = "dev-overlay";
    el.style.cssText = "position:fixed;bottom:6px;left:6px;right:6px;z-index:9999;font-size:11px;opacity:.65;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;pointer-events:none;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap";
    document.body.appendChild(el);
  }
  return el;
}

function setDevOverlayText(parts) {
  const el = ensureDevOverlay();
  if (!el) return;
  el.innerHTML = (parts || [])
    .filter(Boolean)
    .map(t => `<span style=\"background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:10px;padding:6px 8px;\">${escapeHtml(t)}</span>`)
    .join("");
}

/**
 * Cr√©neaux sp√©ciaux (date exacte, heures optionnelles).
 * Format date: "JJ-MM-AAAA"
 * start/end: "HH:mm" (facultatif)
 */

const specialSlots = [
  {
    key: "slot-2025-12-23-countdown",
    date: "23-12-2025",
    item: { key: "countdown-xmas-2025", type: "countdown", theme: "xmas", title: "Patience...", target: "2025-12-25T00:00:00", label: "Le p√®re no√´l arrive ! üéÖüèºüéÑ" }
  },
  {
    key: "slot-2025-12-24-before-17",
    date: "24-12-2025",
    end: "20:00",
    item: {
      key: "msg-xmas-discovery",
      type: "message",
      theme: "xmas",
      title: "Porte-cl√© Magique",
      value: "Trop cool !! Tu as d√©couvert comment fonctionne le porte-cl√© ‚ù§Ô∏èüîì. Tu pourras r√©essayer √† 20h puis 21h. A partir de demain, il te montrera encore plus de nouvelles choses... üòä"
    }
  },
  {
    key: "slot-2025-12-24-17-19",
    date: "24-12-2025",
    start: "20:00",
    end: "21:00",
    item: {
      key: "xmas-evening-magic",
      type: "xmas",
      theme: "xmas",
      title: "Soir de No√´l üéÅ",
      value: "La magie continue ce soir‚Ä¶ ‚ú®",
      image: "https://images.unsplash.com/photo-1543589077-47d81606c1bf?auto=format&fit=crop&w=800&q=80"
    }
  },
  {
    key: "slot-2025-12-24-after-19",
    date: "24-12-2025",
    start: "21:00",
    item: { key: "countdown-xmas-eve", type: "countdown", theme: "xmas", title: "Encore un peu ‚è≥", target: "2025-12-25T00:00:00", label: "Le p√®re no√´l arrive ! üéÖüèºüéÑ" }
  },
  {
    key: "slot-2025-12-25-before-08",
    date: "25-12-2025",
    end: "08:00",
    item: {
      key: "msg-xmas-morning",
      type: "message",
      theme: "xmas",
      title: "Joyeux No√´l Lily üéÑüéÖüèº",
      value: "J‚Äôesp√®re que ce jour sera rempli de surprises, de sourires et de fun !"
    }
  },
  {
    key: "slot-2025-12-25-08-09",
    date: "25-12-2025",
    start: "08:00",
    end: "09:00",
    item: {
      key: "msg-xmas-calls",
      type: "message",
      theme: "xmas",
      title: "Le p√®re no√´l est pass√© !!??",
      value: "J'ai h√¢te qu'on s'appelle pour qu'on se montre nos cadeaux üéÅüéÑ"
    }
  },
  {
    key: "slot-2025-12-25-09-12",
    date: "25-12-2025",
    start: "09:00",
    end: "12:00",
    item: {
      key: "msg-xmas-best-gift",
      type: "message",
      theme: "xmas",
      title: "Tu sais quoi ?",
      value: "Mon meilleur cadeau de No√´l c'est d'√™tre avec toi ‚ù§Ô∏èü•∞"
    }
  },
  {
    key: "slot-2025-12-31-countdown",
    date: "31-12-2025",
    item: {
      key: "countdown-new-year-2026",
      type: "countdown",
      title: "Compte √† rebours üéâ",
      target: "2026-01-01T00:00:00",
      label: "Avant la nouvelle ann√©e"
    }
  },
  {
    key: "slot-2026-04-16-birthday",
    date: "16-04-2026",
    item: {
      key: "msg-birthday-lily",
      type: "message",
      title: "Joyeux anniversaire üéÇ",
      value: "Aujourd‚Äôhui, c‚Äôest ta journ√©e ‚ú® Profite √† fond üíñ"
    }
  }
];

/**
 * Jours sp√©ciaux (date exacte).
 * Format cl√©: "JJ-MM-AAAA"
 */
const specialDays = {
};

// =======================
// Surprises (organis√©es)
// =======================

// 1) Messages (simples)
const SURPRISES_MESSAGES = [
  { key: "msg-1", type: "message", title: "Message secret üíñ", value: "Si tu lis √ßa, c‚Äôest que je pense √† toi üòä" },
  { key: "msg-2", type: "message", title: "Mini pouvoir ‚ú®", value: "Ce porte-cl√© donne des c√¢lins illimit√©s ü§ó" },
  { key: "msg-3", type: "message", title: "Aujourd‚Äôhui üìÜ", value: "Un sourire pour toi üòä" },
  { key: "msg-4", type: "message", title: "Petit sourire üòä", value: "Souris ! Ce message est pour toi" },
  { key: "msg-5", type: "message", title: "Petit rappel ‚≠ê", value: "Tu es quelqu‚Äôun de vraiment chouette !" },
  { key: "msg-6", type: "message", title: "Petit rappel ‚≠ê", value: "üè† Peu importe o√π je suis, je pense √† toi" },
  { key: "msg-7", type: "message", title: "Rappel ‚≠ê", value: "Rappel important : tu es g√©niale" },
  { key: "msg-8", type: "message", title: "C√¢lin ü§ó", value: "C√¢lin virtuel envoy√© avec succ√®s ü§ó" },
  { key: "msg-9", type: "message", title: "Bonne journ√©e üåà", value: "Aujourd‚Äôhui va √™tre une bonne journ√©e" },
  { key: "msg-10", type: "message", title: "Message secret üí´", value: "Tu comptes beaucoup pour moi üíñ" },
  { key: "msg-11", type: "message", title: "Objet magique ü™Ñ", value: "Le porte-cl√© rend heureux quand on le scanne" },
  { key: "msg-12", type: "message", title: "Coupon üç¨", value: "1 sourire gratuit √† vie" },
  { key: "msg-13", type: "message", title: "Amour üíù", value: "Ce c≈ìur est petit mais l‚Äôamour est grand" },
  { key: "msg-14", type: "message", title: "Amour üíù", value: "Ce c≈ìur est petit mais ce qu'on partage est grand" },
  { key: "msg-15", type: "message", title: "Douceur üß∏", value: "Ce message est doux, comme toi" },
  { key: "msg-16", type: "message", title: "Petit rappel ‚≠ê", value: "üåà Merci d‚Äô√™tre toujours l√† pour moi" },
  { key: "msg-17", type: "message", title: "Bonne humeur üòÑ", value: "Niveau de bonne humeur : +100" },
  { key: "msg-18", type: "message", title: "Chance üçÄ", value: "Chance du jour : ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê" },
  { key: "msg-19", type: "message", title: "Pens√©e üíï", value: "Quelqu‚Äôun quelque part t‚Äôappr√©cie beaucoup" },
  { key: "msg-20", type: "message", title: "V≈ìu üéà", value: "Ce message te souhaite une super journ√©e" },
  { key: "msg-21", type: "message", title: "Amour ü´∂", value: "Toi + moi : activ√© ‚ù§Ô∏è" },
  { key: "msg-22", type: "message", title: "Soleil ‚òÄÔ∏è", value: "Tu mets du soleil autour de toi" },
  { key: "msg-23", type: "message", title: "Petit mot üê£", value: "Petit message gentil, juste comme √ßa" },
  { key: "msg-24", type: "message", title: "Message du c≈ìur üíå", value: "Message du c≈ìur, livr√© avec amour" },
  { key: "msg-25", type: "message", title: "√âtincelle ‚ú®", value: "Tu rends le monde un peu plus chouette" },
  { key: "msg-26", type: "message", title: "Cool üòé", value: "Tu es officiellement cool" },
  { key: "msg-27", type: "message", title: "Message secret üíñ", value: "Si tu lis √ßa, c‚Äôest que tu es sp√©ciale" },
  { key: "msg-28", type: "message", title: "Bonne journ√©e üåà", value: "Aujourd‚Äôhui va √™tre une bonne journ√©e" },
  { key: "msg-29", type: "message", title: "Merci üå∏", value: "Merci d‚Äô√™tre toi" },
  { key: "msg-30", type: "message", title: "C√¢lin ü§ó", value: "Ce c≈ìur t‚Äôenvoie un √©norme c√¢lin" }
];

// 2) Useless facts
const SURPRISES_USELESS_FACTS = [
  { key: "fact-1", type: "useless-fact", title: "Fait inutile ü¶¶", value: "Les loutres se tiennent la main pour dormir." },
  { key: "fact-2", type: "useless-fact", title: "Fait inutile üê¢", value: "Les tortues peuvent respirer par leurs fesses." },
  { key: "fact-3", type: "useless-fact", title: "Fait inutile üçå", value: "Les bananes sont des baies, mais les fraises non." },
  { key: "fact-4", type: "useless-fact", title: "Fait inutile üêô", value: "Les pieuvres ont trois c≈ìurs." },
  { key: "fact-5", type: "useless-fact", title: "Fait inutile üêß", value: "Les pingouins ont des genoux, mais ils sont cach√©s." },
  { key: "fact-6", type: "useless-fact", title: "Fait inutile üß†", value: "Ton cerveau consomme environ 20 % de ton √©nergie." },
  { key: "fact-7", type: "useless-fact", title: "Fait inutile üêÑ", value: "Les vaches ont des meilleurs amis et stressent quand ils sont s√©par√©s." },
  { key: "fact-8", type: "useless-fact", title: "Fait inutile üêù", value: "Les abeilles peuvent reconna√Ætre des visages humains." },
  { key: "fact-9", type: "useless-fact", title: "Fait inutile üåç", value: "La Terre n‚Äôest pas parfaitement ronde." },
  { key: "fact-10", type: "useless-fact", title: "Fait inutile ü¶ë", value: "Les calmars ont du sang bleu." }
];

// 3) Self-aware (m√©ta)
const SURPRISES_SELF_AWARE = [
  { key: "meta-1", type: "self-aware", title: "Message conscient ü™û", value: "Ce message sait qu‚Äôil ne sert √† rien. Et il est tr√®s √† l‚Äôaise avec √ßa." },
  { key: "meta-2", type: "self-aware", title: "Message conscient ü™û", value: "Ce message est parfaitement inutile. Mais il est bien pr√©sent√©." },
  { key: "meta-3", type: "self-aware", title: "Message conscient ü™û", value: "Ce message existe uniquement parce que quelqu‚Äôun a scann√© un porte-cl√©." },
  { key: "meta-4", type: "self-aware", title: "Message conscient ü™û", value: "Ce message se regarde √™tre lu. C‚Äôest un peu g√™nant." },
  { key: "meta-5", type: "self-aware", title: "Message conscient ü™û", value: "Ce message n‚Äôa aucun but pr√©cis, et c‚Äôest voulu." },
  { key: "meta-6", type: "self-aware", title: "Message conscient ü™û", value: "Ce message est conscient d‚Äô√™tre un message. Rien de plus." },
  { key: "meta-7", type: "self-aware", title: "Message conscient ü™û", value: "Ce message est en train de prendre ton attention pendant quelques secondes." },
  { key: "meta-8", type: "self-aware", title: "Message conscient ü™û", value: "Ce message sait qu‚Äôil sera oubli√©. Et √ßa lui va." },
  { key: "meta-9", type: "self-aware", title: "Message conscient ü™û", value: "Ce message ne change rien √† ta journ√©e. Sauf peut-√™tre √ßa." },
  { key: "meta-10", type: "self-aware", title: "Message conscient ü™û", value: "Ce message sait tr√®s bien qu‚Äôil aurait pu √™tre autre chose." }
];

// 4) 404
const SURPRISES_404 = [
  { key: "err-404-1", type: "404", title: "Erreur 404", value: "Surprise introuvable‚Ä¶ enfin si üòÑ" },
  { key: "err-404-2", type: "404", title: "Erreur 404", value: "Cette surprise n‚Äôexiste pas. Ou peut-√™tre que si." },
  { key: "err-404-3", type: "404", title: "Erreur 404", value: "Rien √† voir ici. Enfin‚Ä¶ presque." },
  { key: "err-404-4", type: "404", title: "Erreur 404", value: "Tu n‚Äô√©tais pas cens√© voir √ßa. Mais bon, tant pis." },
  { key: "err-404-5", type: "404", title: "Erreur 404", value: "Surprise absente. Essaye d‚Äôimaginer quelque chose de cool." },
  { key: "err-404-6", type: "404", title: "Erreur 404", value: "Erreur d√©tect√©e. Bonne nouvelle : ce n‚Äôest pas grave." },
  { key: "err-404-7", type: "404", title: "Erreur 404", value: "Contenu manquant, mais intention pr√©sente." },
  { key: "err-404-8", type: "404", title: "Erreur 404", value: "Ce message fait semblant d‚Äô√™tre une erreur." },
  { key: "err-404-9", type: "404", title: "Erreur 404", value: "Il n‚Äôy avait rien ici. Maintenant si." },
  { key: "err-404-10", type: "404", title: "Erreur 404", value: "Ceci est un message d‚Äôerreur qui ne sert √† rien." }
];

// 5) Messages affich√© tr√®s t√¥t le matin
const SURPRISES_MORNING = [
  {
    key: "morning-1",
    type: "before-ready",
    title: "On se r√©veille ü•±",
    value: "Ce message fonctionne mieux apr√®s un r√©veil complet üòÑ",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-2",
    type: "before-ready",
    title: "On se r√©veille ü•±",
    value: "Chargement du cerveau‚Ä¶ 12 % üß†",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-3",
    type: "before-ready",
    title: "On se r√©veille ü•±",
    value: "Encore un peu endormie‚Ä¶",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-4",
    type: "before-ready",
    title: "On se r√©veille ü•±",
    value: "Mode d√©marrage lent activ√© üê¢",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-5",
    type: "sleepy-mode",
    title: "Mode dodo üò¥",
    value: "Ce message arrive un peu trop t√¥t.",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-6",
    type: "sleepy-mode",
    title: "Mode dodo üò¥",
    value: "Les yeux sont ouverts. Le cerveau pas encore.",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-7",
    type: "sleepy-mode",
    title: "Mode dodo üò¥",
    value: "Red√©marrage en cours‚Ä¶",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-8",
    type: "sleepy-mode",
    title: "Mode dodo üò¥",
    value: "Encore besoin de quelques minutes.",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-9",
    type: "loading",
    title: "Chargement‚Ä¶ üéÆ",
    value: "Merci de patienter ‚è≥",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-10",
    type: "loading",
    title: "Chargement‚Ä¶ üéÆ",
    value: "Presque pr√™te‚Ä¶",
    start: "05:30", end: "07:15"
  },
  {
    key: "morning-11",
    type: "loading",
    title: "Chargement‚Ä¶ üéÆ",
    value: "Connexion au cerveau r√©ussie üß†",
    start: "05:30", end: "07:15"
  }
]

// 6) Nuit
const SURPRISES_NIGHT = [
  { key: "night-1", type: "night-whisper",
    title: "Chuchotement üåô",
    value: "Chut‚Ä¶ il est tard. Je voulais juste te dire bonne nuit.",
    start: "22:00", end: "03:00"
  },
  { key: "night-2", type: "night-whisper",
    title: "Chuchotement üåô",
    value: "La journ√©e est finie. Repose-toi, tu l‚Äôas m√©rit√© ‚ú®",
    start: "22:00", end: "03:00"
  },
  { key: "night-3", type: "night-whisper",
    title: "Chuchotement üåô",
    value: "M√™me dans le silence, quelqu‚Äôun pense √† toi.",
    start: "22:00", end: "03:00"
  },
  { key: "night-4", type: "night-whisper",
    title: "Chuchotement üåô",
    value: "Pose le t√©l√©phone. Respire. Tout va bien.",
    start: "22:00", end: "03:00"
  },
  { key: "night-5", type: "night-whisper",
    title: "Chuchotement üåô",
    value: "Pourquoi tu es r√©veill√©e? Il faut dormir...",
    start: "22:00", end: "05:30"
  },
];

// 7) Choice
const SURPRISES_CHOICE = [
  {
    key: "choice-1",
    type: "choice",
    title: "Dis-moi ‚ú®",
    question: "L√† tout de suite, tu as plut√¥t envie de‚Ä¶",
    choices: ["Un c√¢lin ü§ó", "Un compliment üíñ", "Une surprise üéÅ"],
    replies: ["C√¢lin virtuel envoy√© üíï", "Tu es vraiment incroyable ‚ú®", "Surprise d√©bloqu√©e üéâ"]
  },
  {
    key: "choice-2",
    type: "choice",
    title: "Dis-moi üí≠",
    question: "L√† tout de suite, tu aurais plut√¥t besoin de‚Ä¶",
    choices: ["Un sourire", "Un moment calme", "Un peu de douceur"],
    replies: ["Sourire envoy√© üôÇ", "Pause autoris√©e üòå", "Douceur livr√©e ‚ù§Ô∏è"]
  },
  {
    key: "choice-3",
    type: "choice",
    title: "Choix rapide ‚ö°",
    question: "Plut√¥t‚Ä¶",
    choices: ["Bouger un peu üôÇ", "Sieste üò¥", "Les deux"],
    replies: ["√áa se tient.", "Tr√®s bon instinct.", "√âquilibre parfait ‚ú®"]
  },
  {
    key: "choice-4",
    type: "choice",
    title: "Petit check ‚ú®",
    question: "Comment tu te sens, l√† maintenant ?",
    choices: ["Bien", "Un peu fatigu√©e", "Tr√®s bien"],
    replies: ["Parfait alors üòä", "Repose-toi un peu ‚ù§Ô∏è", "J‚Äôadore cette √©nergie ‚ú®"]
  },
  {
    key: "choice-5",
    type: "choice",
    title: "Tr√®s s√©rieux ü§î",
    question: "On est d‚Äôaccord que‚Ä¶",
    choices: ["Tu es cool", "Tu es tr√®s cool", "Tu es extr√™mement cool"],
    replies: ["Ca c'est bien vrai.", "Confirm√©.", "Valid√© scientifiquement üòé"]
  },
  {
    key: "choice-6",
    type: "choice",
    title: "Entre nous ‚ù§Ô∏è",
    question: "Ce qui compte le plus, c‚Äôest‚Ä¶",
    choices: ["√ätre l√†", "Partager", "Rire ensemble"],
    replies: ["Toujours ‚ù§Ô∏è", "C‚Äôest exactement √ßa ‚ú®", "Et souvent üòÑ"]
  },
  {
    key: "choice-7",
    type: "choice",
    title: "Petit rappel üíñ",
    question: "Tu sais que‚Ä¶",
    choices: ["Tu comptes", "Tu es importante", "Tu est la best"],
    replies: ["Toujours.", "Vraiment.", "Plus que tu ne le crois ‚ú®"]
  }
];

// 8) Fortune
const SURPRISES_FORTUNE = [
  {
    key: "fortune-1",
    type: "fortune",
    title: "Pr√©diction üîÆ",
    values: [
      "Un sourire inattendu arrive aujourd‚Äôhui üôÇ",
      "Une bonne surprise est plus proche que tu ne le penses ‚ú®",
      "Quelque chose de doux va t‚Äôarriver bient√¥t üíñ",
      "La chance est discr√®te, mais bien l√† üçÄ"
    ]
  },
  {
    key: "fortune-2",
    type: "fortune",
    title: "Oracle du jour ‚ú®",
    values: [
      "Fais confiance √† ton intuition aujourd‚Äôhui",
      "Une petite d√©cision peut tout changer",
      "Ralentir est parfois la meilleure option",
      "Tu es exactement l√† o√π tu dois √™tre"
    ]
  }
];

// 9) Letters
const SURPRISES_LETTERS = [
  { key: "letter-1", type: "letter", title: "Pour toi üíå", value: "Je ne sais pas toujours comment le dire, mais tu comptes √©norm√©ment pour moi." },
  { key: "letter-2", type: "letter", title: "Mot discret ‚ù§Ô∏è", value: "M√™me sans raison particuli√®re, tu m√©rites de la douceur." }
];

// 10) Quotes
const SURPRISES_QUOTES = [
  { key: "quote-1", type: "quote", title: "Citation ‚≠ê", value: "Les petites attentions font les grandes journ√©es.", author: "Anonyme" },
  { key: "quote-2", type: "quote", title: "Citation ‚≠ê", value: "La douceur est une force discr√®te.", author: "Anonyme" },
  { key: "quote-3", type: "quote", title: "Citation ‚≠ê", value: "Parfois, ralentir est d√©j√† avancer.", author: "Anonyme" }
];

// 11) Evolving + Counter
const SURPRISES_PROGRESS = [
  { type: "evolving-message", title: "Message √©volutif üß™", key: "evolve-love-1", words: ["Je", "pense", "√†", "toi", "üíñ"] },
  {
    type: "evolving-message",
    title: "Toujours nous ‚ù§Ô∏è",
    key: "evolve-us-1",
    words: ["Toi", "+", "Moi", "=", "Love"]
  },
  {
    type: "evolving-message",
    title: "Toujours nous ‚ù§Ô∏è",
    key: "evolve-letter-1",
    words: ["J", "E", "T", "A", "I", "M", "E"]
  },
];

// 12) Quiz
const SURPRISES_QUIZ = [
  {
    key: "quiz-1",
    type: "quiz",
    title: "Petit quiz üéØ",
    questions: [
      {
        text: "Quel est mon super-pouvoir secret ?",
        choices: ["Faire rire", "Cuisiner", "Dormir partout", "Tout √† la fois"],
        correctIndex: 0
      },
      {
        text: "Quelle surprise me fait le plus plaisir ?",
        choices: ["Un c√¢lin de toi", "Un d√Æner", "Un voyage", "Une playlist"],
        correctIndex: 0
      },
    ],
    results: [
      { min: 1, title: "Team chill üòÑ", message: "On a un style bien √† nous. J‚Äôadore." },
      { min: 2, title: "Team c≈ìur üíñ", message: "Tu me connais (trop) bien üò≥‚ú®" }
    ]
  },
  {
    key: "quiz-2",
    type: "quiz",
    title: "Vrai ou faux ? Sur moi ü§î",
    questions: [
      {
        text: "Je peux manger des p√¢tes plusieurs jours d‚Äôaffil√©e üçù",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      },
      {
        text: "Je gagne toujours aux jeux de soci√©t√© üé≤",
        choices: ["Vrai", "Faux"],
        correctIndex: 1
      },
      {
        text: "J‚Äôoublie parfois o√π j‚Äôai pos√© mon t√©l√©phone üòÖ",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      },
      {
        text: "Je suis du matin et toujours plein d‚Äô√©nergie ‚òÄÔ∏è",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      },
      {
        text: "Je peux regarder le m√™me film plusieurs fois üé¨",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      },
      {
        text: "Je suis tr√®s fort pour raconter des blagues nulles ü§°",
        choices: ["Vrai", "Faux"],
        correctIndex: 1
      },
      {
        text: "Je range toujours parfaitement mes affaires üßπ",
        choices: ["Vrai", "Faux"],
        correctIndex: 1
      },
      {
        text: "Je pr√©f√®re rester tranquille que courir partout üòå",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      },
      {
        text: "Je suis capable de perdre √† un jeu et de rester calme üòá",
        choices: ["Vrai", "Faux"],
        correctIndex: 1
      },
      {
        text: "J‚Äôadore avoir des cadeaux",
        choices: ["Vrai", "Faux"],
        correctIndex: 0
      }
    ],
    results: [
      {
        min: 0,
        title: "Bien tent√© üòÑ",
        message: "Pas facile de tout deviner ! Mais tu t‚Äôes bien amus√©e, et c‚Äôest le plus important üëç"
      },
      {
        min: 6,
        title: "Bien vu üëÄ",
        message: "Wow ! Tu me connais plut√¥t bien üòé"
      },
      {
        min: 9,
        title: "Expert üèÜ",
        message: "Incroyable ! Tu sais (presque) tout sur moi üòÑ"
      }
    ]
  }
];

// 13) Farfelus
const SURPRISES_FUN = [
  {
    key: "fun-mindread-1",
    type: "mindread",
    title: "Connexion ‚ú®",
    steps: [
      "Pense √† quelqu‚Äôun‚Ä¶",
      "Ne dis rien‚Ä¶",
      "Oui. C‚Äôest bien cette personne ‚ù§Ô∏è"
    ]
  },
  {
    key: "fun-magic8-1",
    type: "magic8", title: "Boule magique üé±", question: "Pose une question (dans ta t√™te)‚Ä¶", answers: ["Oui, clairement", "Redemande plus tard", "Les √©toiles disent oui ‚ú®", "Hmm‚Ä¶ non üòÖ", "C‚Äôest un grand OUI üíñ", "NON, pas du tout!"]
  },
  {
    key: "fun-potion-1",
    type: "potion", title: "Potion üßÉ", name: "Potion de bonne humeur", effects: ["+5 sourires", "+2 √©nergie", "+‚àû c√¢lins (virtuel)"]
  },
  {
    key: "fun-teleport-1",
    type: "teleport", title: "Pr√™t pour l‚Äôaventure ? üöÄ", places: ["Bali üå¥", "Vietnam üáªüá≥", "Ton lit üõå", "A la plage üèñÔ∏è", "Mars üöÄ", "Un spa üßñ‚Äç‚ôÄÔ∏è", "Disneyland üé¢", "Pr√®s de moi üòÖ"]
  },
  {
    key: "fun-animal-emoji-1",
    type: "animal-emoji", title: "Animal Emoji !"
  },
  {
    key: "fun-random-thought-1",
    type: "random-thought",
    title: "Pens√©e random üí≠",
    values: [
      // üê£ Fun / l√©g√®res
      "Et si les nuages √©taient juste fatigu√©s ?",
      "Est-ce que les poissons ont l‚Äôimpression de voler ?",
      "Si on mange une √©toile, est-ce qu‚Äôon brille ? ‚ú®",
      "Les dinosaures auraient ador√© les skateboards üõπ",
      "Un nuage ressemble toujours √† quelque chose.",
      "Les poissons ont-ils l‚Äôimpression de voler ?",

      // üòÑ Absurdes (11 ans friendly)
      "Un pingouin pourrait-il porter un bonnet ?",
      "Les chaussettes disparaissent-elles expr√®s ?",
      "Les arbres se parlent-ils la nuit ? üåô",
      "Si les murs pouvaient parler, seraient-ils polis ?",
      "Un escargot r√™ve-t-il de vitesse ? üêå",

      // ‚ú® Douces / po√©tiques
      "Parfois, ne rien faire est d√©j√† quelque chose.",
      "Le silence aussi a des choses √† dire.",
      "Une bonne journ√©e commence parfois par une id√©e rigolote.",
      "Et si aujourd‚Äôhui √©tait une bonne journ√©e sans raison particuli√®re ?",

      // üéØ Tr√®s simples
      "Cette pens√©e n‚Äôa aucun but pr√©cis. Et c‚Äôest tr√®s bien.",
      "Quelqu‚Äôun, quelque part, est en train de sourire.",
      "Il n‚Äôy avait rien √† comprendre ici.",
      "Cette phrase existe juste pour exister."
    ]
  },
  {
    key: "fun-glitch-1",
    type: "glitch", title: "Glitch üß†", value: "R√©alit√© instable‚Ä¶"
  },
  {
    key: "fun-disco-1",
    type: "disco", title: "Mode disco ü™©", duration: 25000, value: "OK‚Ä¶ petite f√™te priv√©e üòÑ"
  }
];

// 14) Images / liens
const SURPRISES_MEDIA = [
  { key: "media-1", type: "image", title:"Image surprise üñºÔ∏è", value: "https://cataas.com/cat/?width=500&height=420" },
  { key: "media-2", type: "image", title:"Chat ch'est une surprise üò∏", value: "https://cataas.com/cat/cute?width=500&height=420" },
  { key: "media-3", type: "image", title:"Chat ch'est une surprise üò∏", value: "https://cataas.com/cat/says/Joyeux no√´l !!?width=500&height=420" },
  //{ type: "image", title: "Image surprise üñºÔ∏è", value: "https://picsum.photos/500/420" },
  { key: "media-4", type: "link", title: "√Ä √©couter üéµ", label: "Ouvrir la musique", value: "https://music.apple.com/fr/album/melodrama/1840188173?i=1840188177" },
  { key: "media-5", type: "link", title: "Petit moment üì∫", label: "Ouvrir la vid√©o", value: "https://www.youtube.com/watch?v=fCWvZisydrE" }
];

// =======================
// Tableau final concat√©n√©
// =======================
// üéÅ Tes surprises ‚Äúnormales‚Äù
const surprises = [
  ...SURPRISES_MESSAGES,
  ...SURPRISES_MEDIA,

  ...SURPRISES_USELESS_FACTS,
  ...SURPRISES_SELF_AWARE,
  ...SURPRISES_404,

  ...SURPRISES_MORNING,
  ...SURPRISES_NIGHT,
  ...SURPRISES_CHOICE,
  ...SURPRISES_FORTUNE,

  ...SURPRISES_LETTERS,
  ...SURPRISES_QUOTES,

  ...SURPRISES_PROGRESS,

  ...SURPRISES_QUIZ,
  ...SURPRISES_FUN
];

const UI = {
  title: document.getElementById("title"),
  subtitle: document.getElementById("subtitle"),
  content: document.getElementById("content")
};

const PAGE_LOAD_REAL_MS = Date.now();
const DATE_PARAM_BASE = getDateFromUrl(); // peut √™tre null

function toParisWallClockDate(instant) {
  // Convertit un instant en Date dont les champs (getHours/getDate/etc.)
  // correspondent √† l'heure Europe/Paris, m√™me si l'appareil est sur une autre timezone.
  return new Date(instant.toLocaleString("en-US", { timeZone: "Europe/Paris" }));
}

function getNow() {
  // Si ?date= est fourni, on ‚Äúfait vivre‚Äù le temps depuis cette base (tick r√©el)
  // ET on force toujours les champs en heure de Paris (sinon getHours() d√©pend du device).
  if (DATE_PARAM_BASE) {
    const instant = new Date(DATE_PARAM_BASE.getTime() + (Date.now() - PAGE_LOAD_REAL_MS));
    return toParisWallClockDate(instant);
  }
  return getParisDate();
}

function getActiveSurprises(surprises, now) {
  const timedActive = surprises.filter(
    it =>
      typeof it.start === "string" &&
      typeof it.end === "string" &&
      isWithinWindow(now, it.start, it.end)
  );

  // ‚úÖ S'il y a des items horaires actifs ‚Üí exclusifs
  if (timedActive.length > 0) {
    return timedActive;
  }

  // ‚úÖ Sinon ‚Üí uniquement les items sans start/end
  return surprises.filter(
    it => typeof it.start !== "string" && typeof it.end !== "string"
  );
}

const HISTORY_KEY = "recentSurpriseKeys";
const HISTORY_SIZE = 24; // √©vite les 24 derniers (‚âà 24h)
const PICK_CACHE_PREFIX = "pick@"; // cache du tirage par heure
const HISTORY_HOUR_KEY = "historyLastHour"; // √©vite d'ajouter au reload

function getHistory() {
    try {
        const v = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        return Array.isArray(v) ? v : [];
    } catch {
        return [];
    }
}

function saveToHistory(key) {
    if (!key) return;
    const h = getHistory().filter(k => k !== key);
    h.unshift(key);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(0, HISTORY_SIZE)));
}

function getHourKey(now, salt) {
  return hourSeedKey(now, salt);
}

function getCachedPickKey(now, salt) {
  return localStorage.getItem(PICK_CACHE_PREFIX + getHourKey(now, salt));
}

function setCachedPickKey(now, salt, key) {
  if (!key) return;
  localStorage.setItem(PICK_CACHE_PREFIX + getHourKey(now, salt), key);
}

function findByKey(list, key) {
  if (!key) return null;
  return list.find(it => it && it.key === key) || null;
}

function saveToHistoryOncePerHour(now, salt, key) {
  if (!key) return;
  const hk = getHourKey(now, salt);
  const last = localStorage.getItem(HISTORY_HOUR_KEY);
  if (last === hk) return; // d√©j√† compt√© pour cette heure
  localStorage.setItem(HISTORY_HOUR_KEY, hk);
  saveToHistory(key);
}

/* ==========================================================
   2) SELECTION
========================================================== */

// ---- Weighted + No-repeat (stable per hour) ----
const TYPE_WEIGHTS = {
    "message": 4,
    "useless-fact": 2,
    "animal-emoji": 1,
    "random-thought": 1,
    "choice": 2,
    "quiz": 2,
    "quiz-images": 1,
    "evolving-message": 3,
    "fortune": 2,
    "teleport": 2,
    "xmas": 1,
    "countdown": 0.5,
    "image": 3,
    "link": 1,
    "self-aware": 0.5,
    "night-whisper": 0.5,
    "404": 0.2,
    "letter": 2,
    "quote": 1,
    "story": 1
};

function weightOf(item) {
    const typeW = (TYPE_WEIGHTS[item.type] ?? 1);
    const itemW = (typeof item.weight === "number") ? item.weight : 1;
    return Math.max(0.001, typeW * itemW);
}

function hourSeedKey(now, salt) {
    return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}-${now.getHours()}|${salt}`;
}

function scoreForItem(item, seedBase) {
    // random d√©terministe par item (ind√©pendant de l'ordre du tableau)
    const rand = mulberry32(hashString(seedBase + "|" + item.key));
    const u = Math.max(1e-9, rand());
    const w = weightOf(item);
    // Plus w est grand, plus l'item gagne souvent
    return Math.pow(u, 1 / w);
}

function pickHourlyWeightedNoRepeat(items, now, salt) {
    if (!items || items.length === 0) return null;

    const seedBase = hourSeedKey(now, salt);
    const recent = getHistory();

    let best = null;
    let bestScore = -Infinity;

    // 1) On √©vite l'historique
    for (const it of items) {
        if (!it || !it.key) continue;
        if (recent.includes(it.key)) continue;
        const score = scoreForItem(it, seedBase);
        if (score > bestScore) {
            bestScore = score;
            best = it;
        }
    }

    // 2) Si tout est bloqu√© (peu d'items), on rel√¢che la contrainte
    if (!best) {
        for (const it of items) {
            if (!it || !it.key) continue;
            const score = scoreForItem(it, seedBase);
            if (score > bestScore) {
                bestScore = score;
                best = it;
            }
        }
    }

    return best;
}

function getKeyFromUrl() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("key");
  if (!raw) return null;
  const k = raw.trim();
  return k ? k : null;
}

function getItemFromUrl(activeList) {
  // ‚úÖ Priorit√© au param√®tre ?key= (plus stable que ?i=)
  const k = getKeyFromUrl();
  if (k) {
    // On cherche dans toutes les sources possibles
    const pool = [
      ...specialSlots.map(s => s.item),
      ...Object.values(specialDays || {}),
      ...surprises
    ].filter(Boolean);

    const found = pool.find(it => it && it.key === k) || null;
    if (!found && isDev()) console.warn("‚ö†Ô∏è key inconnue dans l'URL :", k);
    return found;
  }

  // Fallback historique : ?i=
  const idx = getIndexFromUrl(activeList.length);
  return (idx !== null) ? activeList[idx] : null;
}

function getHourlyItem(list, now, salt) {
  const idx = getHourlyIndex(list.length, now, salt);
  return list[idx];
}

/* ==========================================================
   3) RENDER
========================================================== */

function renderPage(item, now) {
  // reset √©tats visuels
  document.body.classList.remove("xmas", "disco");
  UI.title.textContent = item.title || "Surprise üíñ";

  if (item && typeof item.theme === "string") {
    document.body.classList.add(item.theme);
  }

  const ribbonEl = document.getElementById("ribbon");
  if (ribbonEl) {
    ribbonEl.textContent = getRibbonText(item, now);
  }

  if (isDev()) {
    const slot = getSpecialSlotDebug(now);
    setDevOverlayText([
      `now: ${formatDDMMYYYY(now)} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`,
      item?.key ? `item: ${item.key}` : "item: (no key)",
      slot?.key ? `slot: ${slot.key}` : "slot: (none)",
      `history: ${getHistory().length}/${HISTORY_SIZE}`,
      `hourKey: ${getHourKey(now, SALT)}`
    ]);
  }

  renderItem(item, UI.content, now);
}

function renderItem(item, content, now) {
  switch (item.type) {
    case "message":
      content.innerHTML = `<p class="msg">${escapeHtml(item.value)}</p>`;
      return;

    case "xmas":
      document.body.classList.add("xmas");
      content.innerHTML = `
        ${item.image ? `<img class="img" src="${item.image}" alt="No√´l">` : ""}
        <p class="msg">${escapeHtml(item.value)}</p>
      `;
      return;

    case "image":
      content.innerHTML = `<img class="img" src="${item.value}" alt="Image surprise">`;
      return;

    case "link":
      content.innerHTML = `
        <p class="msg">J‚Äôai un truc pour toi üòÑ</p>
        <a class="btn" href="${item.value}" target="_blank" rel="noopener">${escapeHtml(item.label || "Ouvrir")}</a>
      `;
      return;

    case "quiz":
      renderQuiz(item, content);
      return;

    case "quiz-images": {
    const q = item.questions[0];

    content.innerHTML = `
      <p class="msg">${escapeHtml(q.question)}</p>
      <div class="grid-choices">
        ${q.choices.map((c, i) => `
          <button class="choice-img" data-correct="${!!c.correct}">
            <img src="${c.img}" alt="">
            <span>${escapeHtml(c.label)}</span>
          </button>
        `).join("")}
      </div>
      <p class="small" id="quizResult"></p>
    `;

    content.querySelectorAll(".choice-img").forEach(btn => {
      btn.addEventListener("click", () => {
        const ok = btn.dataset.correct === "true";
        content.querySelector("#quizResult").textContent =
          ok ? "Bravo üéâ Bonne r√©ponse !" : "Presque üòÑ";
      });
    });

    return;
    }

    case "story":
      renderStory(item, content, now);
      return;

    case "mindread":
      renderMindread(item, content);
      break;

    case "magic8":
      renderMagic8(item, content);
      return;

    case "choice":
      renderChoice(item, content);
      return;

    case "fortune":
      renderFortune(item, content);
      return;

    case "animal-emoji": {
      const emoji = randomAnimalEmoji();
      content.innerHTML = `
      <div class="big-emoji">${emoji}</div>
      <p class="animal-label">Animal du moment</p>
      `;
      return;
    }

    case "potion":
      content.innerHTML = `
        <p class="msg"><strong>${escapeHtml(item.name || "Potion")}</strong></p>
        <p class="msg">${(item.effects || []).map(e => "‚Ä¢ " + escapeHtml(e)).join("<br>")}</p>
      `;
      return;

    case "random-thought": {
      const values = item.values || [];

      const pick = () =>
      values[Math.floor(Math.random() * values.length)] || "";

      content.innerHTML = `
        <p class="msg" id="thought">${escapeHtml(pick())}</p>
        <button class="btn" type="button" id="newThought">Encore une üí≠</button>
      `;

      const thoughtEl = content.querySelector("#thought");
      const btn = content.querySelector("#newThought");

      btn.addEventListener("click", () => {
        thoughtEl.textContent = pick();
      });

      return;
    }

    case "404":
    case "self-aware":
    case "useless-fact":
    case "night-whisper":
    case "coffee-needed":
    case "loading":
    case "before-ready":
    case "sleepy-mode":
      content.innerHTML = `<p class="msg">${escapeHtml(item.value || "")}</p>`;
      return;

    case "evolving-message":
      renderEvolving(item, content, now);
      return;

    case "countdown":
      renderCountdown(item, content);
      return;

        // --- Texte long / quote ---
    case "letter":
      content.innerHTML = `<p class="msg" style="white-space:pre-wrap;">${escapeHtml(item.value || "")}</p>`;
      return;

    case "quote":
      content.innerHTML = `
        <p class="msg">‚Äú${escapeHtml(item.value || "")}‚Äù</p>
        ${item.author ? `<p class="small" style="margin-top:10px;">‚Äî ${escapeHtml(item.author)}</p>` : ""}
      `;
      return;

    case "glitch":
      content.innerHTML = `<p class="msg glitch">${escapeHtml(item.value || "")}</p>`;
      break;

    case "teleport":
      renderTeleport(item, content);
      return;

    case "disco":
      document.body.classList.add("disco");
      content.innerHTML = `<p class="msg">${escapeHtml(item.value || "ü™©")}</p>`;
      setTimeout(() => document.body.classList.remove("disco"), item.duration || 2500);
      break;

    default:
      content.innerHTML = `<p class="msg">Type inconnu: ${escapeHtml(item.type)}</p>`;
      return;
  }
}

/* ==========================================================
   4) TYPES (renders)
========================================================== */

function renderQuiz(quizItem, mountEl) {
  const questions = quizItem.questions || [];
  if (!questions.length) {
    mountEl.innerHTML = `<p class="msg">Quiz indisponible üòÖ</p>`;
    return;
  }

  let qIndex = 0;
  let score = 0;

  const render = () => {
    const q = questions[qIndex];
    mountEl.innerHTML = `
      <p class="msg">${escapeHtml(q.text)}</p>
      <div class="quiz-progress">Question ${qIndex + 1} / ${questions.length}</div>
      <div id="quizChoices"></div>
      <div class="quiz-score">Score : ${score}</div>
    `;

    const choicesEl = mountEl.querySelector("#quizChoices");
    q.choices.forEach((choiceText, idx) => {
      const btn = document.createElement("button");
      btn.className = "quiz-btn";
      btn.type = "button";
      btn.textContent = choiceText;
      btn.addEventListener("click", () => onAnswer(idx));
      choicesEl.appendChild(btn);
    });
  };

  const onAnswer = (chosenIdx) => {
    const q = questions[qIndex];
    if (chosenIdx === q.correctIndex) score++;
    qIndex++;
    if (qIndex >= questions.length) renderResult();
    else render();
  };

  const renderResult = () => {
    const total = questions.length;

    let res = null;
    const list = quizItem.results || [];
    for (const r of list) if (typeof r.min === "number" && score >= r.min) res = r;

    const title = res?.title || "R√©sultat üéâ";
    const message = res?.message || `Tu as fait ${score}/${total} !`;

    UI.title.textContent = quizItem.title || "Quiz üéØ";

    mountEl.innerHTML = `
      <p class="msg"><strong>${escapeHtml(title)}</strong></p>
      <p class="msg">${escapeHtml(message)}</p>
      <p class="msg">Score final : <strong>${score}/${total}</strong> ‚ú®</p>
      <button class="btn" type="button" id="quizReplay">Rejouer</button>
    `;

    mountEl.querySelector("#quizReplay").addEventListener("click", () => {
      qIndex = 0;
      score = 0;
      render();
    });
  };

  render();
}

function renderMagic8(item, content) {
  const answers = item.answers || [];
  content.innerHTML = `
    <p class="msg">${escapeHtml(item.question || "Pose une question‚Ä¶")}</p>
    <button class="btn" type="button" id="m8">R√©v√©ler</button>
    <p class="msg" id="m8a" style="margin-top:10px;"></p>
  `;
  content.querySelector("#m8").addEventListener("click", () => {
    const a = answers[Math.floor(Math.random() * answers.length)] || "‚ú®";
    content.querySelector("#m8a").textContent = a;
  });
}

function renderFortune(item, content) {
  const values = item.values || [];
  if (!values.length) return;

  content.innerHTML = `
    <p class="msg">Tire une pr√©diction üòÑ</p>
    <button class="btn" type="button" id="fortuneBtn">Tirer üîÆ</button>
    <p class="msg" id="fortuneText" style="display:none; margin-top:14px;"></p>
  `;

  const btn = content.querySelector("#fortuneBtn");
  const text = content.querySelector("#fortuneText");

  btn.addEventListener("click", () => {
      const pick = values[Math.floor(Math.random() * values.length)];
      text.textContent = pick;
      text.style.display = "block"; // üëà appara√Æt au 1er clic
  });
}

function renderChoice(item, content) {
  const choices = item.choices || [];
  const replies = item.replies || [];
  content.innerHTML = `
    <p class="msg">${escapeHtml(item.question || "Choisis")}</p>
    <div id="choiceBtns"></div>
    <p class="msg" id="choiceReply" style="margin-top:10px;"></p>
  `;
  const wrap = content.querySelector("#choiceBtns");
  const reply = content.querySelector("#choiceReply");
  choices.forEach((c, i) => {
    const b = document.createElement("button");
    b.className = "quiz-btn";
    b.type = "button";
    b.textContent = c;
    b.addEventListener("click", () => { reply.textContent = replies[i] || "‚ú®"; });
    wrap.appendChild(b);
  });
}

function renderEvolving(item, content, effectiveDate) {
  const baseKey = item.key || "evolve";
  const words = item.words || [];

  cleanupOldEvolveKeys(baseKey, 10);

  const y = effectiveDate.getFullYear();
  const m = String(effectiveDate.getMonth() + 1).padStart(2, "0");
  const d = String(effectiveDate.getDate()).padStart(2, "0");
  const dayKey = `${y}-${m}-${d}`;

  const key = `${baseKey}@${dayKey}`;

  let n = Number(localStorage.getItem(key)) || 0;
  n = Math.min(n + 1, words.length);
  localStorage.setItem(key, String(n));

  const done = n >= words.length;

  content.innerHTML = `
    <p class="msg" style="font-size:20px;">${escapeHtml(words.slice(0, n).join(" "))}</p>
    ${
      done
        ? `<button class="btn" type="button" id="evoRestart">Recommencer</button>`
        : `<p class="small">Scan encore pour la suite ‚ú®</p>`
    }
  `;

  if (done) {
    content.querySelector("#evoRestart").addEventListener("click", () => {
      localStorage.removeItem(key);
      renderEvolving(item, content, effectiveDate);
    });
  }
}

function cleanupOldEvolveKeys(baseKey, keepDays = 7) {
  const cutoff = Date.now() - keepDays * 86400000;
  for (const k of Object.keys(localStorage)) {
    if (!k.startsWith(baseKey + "@")) continue;
    const dateStr = k.split("@")[1]; // YYYY-MM-DD
    const t = new Date(dateStr + "T00:00:00").getTime();
    if (!isNaN(t) && t < cutoff) localStorage.removeItem(k);
  }
}

function renderMindread(item, content) {
  const steps = item.steps || [];
  let i = 0;
  content.innerHTML = `
    <p class="msg" id="mrText">${escapeHtml(steps[0] || "‚Ä¶")}</p>
    <button class="btn" type="button" id="mrNext">Suivant</button>
  `;
  const text = content.querySelector("#mrText");
  const btn = content.querySelector("#mrNext");
  btn.addEventListener("click", () => {
    i = Math.min(i + 1, steps.length - 1);
    text.textContent = steps[i] || "‚Ä¶";
    if (i >= steps.length - 1) btn.textContent = "OK ‚ú®";
  });
}

window.countdownInterval = null;

function renderCountdown(item, content) {
  if (window.countdownInterval) {
    clearInterval(window.countdownInterval);
    window.countdownInterval = null;
  }

  const target = new Date(item.target);
  if (isNaN(target.getTime())) {
    content.innerHTML = `<p class="msg">Countdown invalide üòÖ</p>`;
    return;
  }

  content.innerHTML = `
    ${item.label ? `<p class="small">${escapeHtml(item.label)}</p>` : ""}
    <p class="msg" style="font-size:22px;" id="cdValue"></p>
  `;

  const out = content.querySelector("#cdValue");

  const update = () => {
    const now = getNow();
    let diff = Math.floor((target.getTime() - now.getTime()) / 1000);

    if (diff <= 0) {
      out.innerHTML = `<strong>0j 00h 00m 00s</strong> ‚ú®`;
      clearInterval(window.countdownInterval);
      window.countdownInterval = null;
      return;
    }

    const d = Math.floor(diff / 86400); diff %= 86400;
    const h = Math.floor(diff / 3600);  diff %= 3600;
    const m = Math.floor(diff / 60);
    const s = diff % 60;

    out.innerHTML = `<strong>${d}j ${pad2(h)}h ${pad2(m)}m ${pad2(s)}s</strong>`;
  };

  update();
  window.countdownInterval = setInterval(update, 1000);
}

    function renderStory(item, content, effectiveDate) {
      const nodes = item.nodes || {};
      const startId = item.startNode || item.start || "start";

      if (!nodes || typeof nodes !== "object" || !nodes[startId]) {
        content.innerHTML = `<p class="msg">Histoire invalide üòÖ</p>`;
        return;
      }

      // Progress par jour (pour √©viter de rester bloqu√© sur une vieille partie)
      const y = effectiveDate.getFullYear();
      const m = String(effectiveDate.getMonth() + 1).padStart(2, "0");
      const d = String(effectiveDate.getDate()).padStart(2, "0");
      const dayKey = `${y}-${m}-${d}`;

      const storageKey = `story@${item.key || "story"}@${dayKey}`;

      const loadNodeId = () => {
        const saved = localStorage.getItem(storageKey);
        if (saved && nodes[saved]) return saved;
        return startId;
      };

      const saveNodeId = (id) => {
        if (!id) return;
        localStorage.setItem(storageKey, id);
      };

      const reset = () => {
        localStorage.removeItem(storageKey);
        renderNode(startId);
      };

      const renderNode = (nodeId) => {
        const node = nodes[nodeId];
        if (!node) {
          content.innerHTML = `<p class="msg">Oups‚Ä¶ la suite est introuvable üòÖ</p>`;
          content.innerHTML += `<button class="btn" type="button" id="storyRestart">Recommencer</button>`;
          content.querySelector("#storyRestart").addEventListener("click", reset);
          return;
        }

        // Fin
        if (typeof node.end === "string") {
          content.innerHTML = `
            <p class="msg">${escapeHtml(node.end)}</p>
            <button class="btn" type="button" id="storyRestart">Recommencer üîÅ</button>
            <p class="small">Fin de l'histoire ‚ú®</p>
          `;
          content.querySelector("#storyRestart").addEventListener("click", reset);
          return;
        }

        const choices = Array.isArray(node.choices) ? node.choices : [];

        content.innerHTML = `
          <p class="msg">${escapeHtml(node.text || "")}</p>
          <div id="storyChoices"></div>
          <button class="btn" type="button" id="storyRestart" style="margin-top:14px;">Recommencer üîÅ</button>
        `;

        const wrap = content.querySelector("#storyChoices");

        // Si aucun choix, on propose juste recommencer
        if (choices.length === 0) {
          const p = document.createElement("p");
          p.className = "small";
          p.textContent = "(Pas de choix ici‚Ä¶ c‚Äôest bizarre üòÖ)";
          wrap.appendChild(p);
        } else {
          choices.forEach((c) => {
            const b = document.createElement("button");
            b.className = "quiz-btn";
            b.type = "button";
            b.textContent = c.label || "Choisir";
            b.addEventListener("click", () => {
              const next = c.next;
              if (!next) return;
              saveNodeId(next);
              renderNode(next);
            });
            wrap.appendChild(b);
          });
        }

        content.querySelector("#storyRestart").addEventListener("click", reset);
      };

      // Start
      const nodeId = loadNodeId();
      renderNode(nodeId);
    }

/* ==========================================================
   5) SPECIAL DAYS / SLOTS
========================================================== */

function getSpecialDayItem(date) {
  const key = formatDDMMYYYY(date);
  return specialDays[key] || null;
}

function getSpecialSlotItem(date) {
  const key = formatDDMMYYYY(date);
  const nowMin = minutesOfDay(date);

  for (const s of specialSlots) {
    if (s.date !== key) continue;

    const startMin = parseHM(s.start, 0);
    const endMin   = parseHM(s.end, 1439);

    if (inOptionalWindow(nowMin, startMin, endMin)) return s.item;
  }
  return null;
}

function getSpecialSlotDebug(date) {
  const key = formatDDMMYYYY(date);
  const nowMin = minutesOfDay(date);

  for (const s of specialSlots) {
    if (s.date !== key) continue;

    const startMin = parseHM(s.start, 0);
    const endMin   = parseHM(s.end, 1439);

    if (inOptionalWindow(nowMin, startMin, endMin)) return s;
  }
  return null;
}

function randomAnimalEmoji() {
  const ANIMAL_EMOJIS = [
    "üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ",
    "ü¶Å","üêÆ","üê∑","üê∏","üêµ","üêî","üêß","üê¶","üê§","ü¶Ü",
    "ü¶â","ü¶Ñ","üêù","ü¶ã","üê¢","üêç","ü¶ñ","ü¶ï","üêô","ü¶ë",
    "üê†","üê≥","ü¶à","üêä","ü¶í","ü¶ì"
  ];
  return ANIMAL_EMOJIS[Math.floor(Math.random() * ANIMAL_EMOJIS.length)];
}

function renderTeleport(item, content) {
  const places = item.places || [];

  content.innerHTML = `
    <button class="btn" type="button" id="tpBtn">Se t√©l√©porter üåÄ</button>
    <p class="msg" id="tpLabel" style="margin-top:14px; display:none;">
      Vous √™tes arriv√©s ici :
    </p>
    <p class="msg teleport-value" id="tp">Appuie pour te t√©l√©porter ‚ú®</p>
  `;

  const tp = content.querySelector("#tp");
  const btn = content.querySelector("#tpBtn");
  const label = content.querySelector("#tpLabel");

  let spinning = false;

  const spin = () => {
    label.style.display = "block"; // üëà affiche le texte
    if (spinning || places.length === 0) return;
    spinning = true;
    btn.disabled = true;

    const duration = 900;
    const interval = 80;
    let elapsed = 0;

    const spinner = setInterval(() => {
      tp.textContent = places[Math.floor(Math.random() * places.length)];
      elapsed += interval;
    }, interval);

    setTimeout(() => {
      clearInterval(spinner);
      tp.textContent =
        places[Math.floor(Math.random() * places.length)] || "Quelque part ‚ú®";
      spinning = false;
      btn.disabled = false;
    }, duration);
  };

  btn.addEventListener("click", spin);
}

/* ==========================================================
   6) URL / DATE HELPERS
========================================================== */

function getIndexFromUrl(n) {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get("i");
  if (raw === null) return null;

  const idx = Number(raw);
  if (!Number.isInteger(idx)) return null;
  if (idx < 0 || idx >= n) return null;
  return idx;
}

function getDateFromUrl() {
  const params = new URLSearchParams(location.search);
  let raw = params.get("date");
  if (!raw) return null;

  // autorise 19h00 ‚Üí 19:00
  raw = raw.replace(/(\d{2})h(\d{2})/, "$1:$2");

  const match = raw.match(/^(\d{2})-(\d{2})-(\d{4})(?:T(\d{2}):(\d{2}))?$/);
  if (!match) return null;

  const [, dd, mm, yyyy, hh = "00", min = "00"] = match;

  // On part d'un instant "candidat" en UTC‚Ä¶
  const y = Number(yyyy), mo = Number(mm), d = Number(dd), h = Number(hh), mi = Number(min);
  let candidate = new Date(Date.UTC(y, mo - 1, d, h, mi, 0));

  // ‚Ä¶puis on ajuste pour que l'heure affich√©e √† Paris corresponde aux valeurs demand√©es.
  const fmt = new Intl.DateTimeFormat("en-CA", {
    timeZone: "Europe/Paris",
    hour12: false,
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit"
  });

  const parts = Object.fromEntries(
    fmt.formatToParts(candidate)
      .filter(p => p.type !== "literal")
      .map(p => [p.type, p.value])
  );

  const gotY = Number(parts.year), gotM = Number(parts.month), gotD = Number(parts.day);
  const gotMin = Number(parts.hour) * 60 + Number(parts.minute);
  const wantMin = h * 60 + mi;

  const dayDelta = Math.round(
    (Date.UTC(gotY, gotM - 1, gotD) - Date.UTC(y, mo - 1, d)) / 86400000
  );

  // Si l'heure affich√©e √† Paris (got) est en avance sur l'heure d√©sir√©e (want),
  // on retire ces minutes √† l'instant candidat.
  const deltaMinutes = (gotMin - wantMin) + dayDelta * 1440;
  const result = new Date(candidate.getTime() - deltaMinutes * 60000);

  return isNaN(result.getTime()) ? null : result;
}

function getParisDate() {
  return toParisWallClockDate(new Date());
}

function timeToMinutes(hhmm) {
  const [h, m] = hhmm.split(":").map(Number);
  return h * 60 + m;
}

function isWithinWindow(now, start, end) {
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const startMin = timeToMinutes(start);
  const endMin = timeToMinutes(end);

  // g√®re les fen√™tres qui passent minuit (ex: 22:00 -> 02:00)
  if (startMin <= endMin) return nowMin >= startMin && nowMin < endMin;
  return nowMin >= startMin || nowMin < endMin;
}

function isTimed(item) {
  return typeof item.start === "string" && typeof item.end === "string";
}

function isActiveTimed(item, now) {
  if (!isTimed(item)) return false;
  return isWithinWindow(now, item.start, item.end);
}

/* ==========================================================
   7) TIME WINDOW HELPERS
========================================================== */

function formatDDMMYYYY(date) {
  const dd = String(date.getDate()).padStart(2, "0");
  const mm = String(date.getMonth() + 1).padStart(2, "0");
  const yyyy = date.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function minutesOfDay(date) {
  return date.getHours() * 60 + date.getMinutes();
}

function parseHM(hm, fallback) {
  if (!hm) return fallback;
  const [h, m] = hm.split(":").map(Number);
  return h * 60 + m;
}

function inOptionalWindow(nowMin, startMin, endMin) {
  if (startMin <= endMin) return nowMin >= startMin && nowMin < endMin;
  return nowMin >= startMin || nowMin < endMin; // passe minuit
}

/* ==========================================================
   8) HOURLY INDEX (seeded)
========================================================== */

// Hash simple et stable (FNV-1a 32-bit) : string -> number
function hashString(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
    }
    return h >>> 0;
}

function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function () {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  };
}

function mulberry32(seed) {
  return function () {
    let t = (seed += 0x6D2B79F5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function hourBucket(date) {
  return Math.floor(date.getTime() / 3600000);
}

function indexForHour(bucket, n, salt, attempt = 0) {
  const seedFn = xmur3(`${salt}|${bucket}|${attempt}`);
  const rng = mulberry32(seedFn());
  return Math.floor(rng() * n);
}

/**
 * Index stable par heure + √©vite d'avoir le m√™me que l'heure pr√©c√©dente (et prev+1 si possible).
 */
function getHourlyIndex(n, date, salt) {
  if (!Number.isInteger(n) || n <= 0) throw new Error("n must be > 0");

  const b = hourBucket(date);
  const prev = (n === 1) ? 0 : indexForHour(b - 1, n, salt);

  const forbid = new Set();
  if (n >= 2) forbid.add(prev);
  if (n >= 3) forbid.add((prev + 1) % n);

  for (let attempt = 0; attempt < 20; attempt++) {
    const candidate = indexForHour(b, n, salt, attempt);
    if (!forbid.has(candidate)) return candidate;
  }

  // fallback: √©viter juste prev
  if (n >= 2) {
    for (let attempt = 0; attempt < 100; attempt++) {
      const candidate = indexForHour(b, n, salt, attempt + 1000);
      if (candidate !== prev) return candidate;
    }
  }
  return 0;
}

/* ==========================================================
   9) SMALL HELPERS
========================================================== */

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

function pad2(n){ return String(n).padStart(2, "0"); }

/* ==========================================================
   10) RECIPIENT HELPERS
========================================================== */

function getRibbonText(item, effectiveDate) {
  // priorit√© 1 : type sp√©cial
  if (!item) return "Pour Lily üíñ";

  switch (item.type) {
    case "xmas":
      return "Pour Lily üéÑ";

    case "birthday":
      return "Pour Lily üéÇ";

    case "quiz":
      return "Pour Lily üéØ";

    case "countdown":
      return "Pour Lily ‚è≥";

    default:
      break;
  }

  // priorit√© 2 : date sp√©ciale (si jamais)
  const d = effectiveDate.getDate();
  const m = effectiveDate.getMonth() + 1;

  if (d === 25 && m === 12) return "Pour Lily üéÑ";

  return "Pour Lily üíñ";
}

/* ==========================================================
 11) INIT
========================================================== */

function init() {
    const now = getNow();
    ensureDevBanner();
    console.log(formatDDMMYYYY(now), `${pad2(now.getHours())}:${pad2(now.getMinutes())}`);

    const activeSurprises = getActiveSurprises(surprises, now);
    const item =
    getSpecialSlotItem(now) ||
    getSpecialDayItem(now) ||
    getItemFromUrl(activeSurprises) ||
    (() => {
      // ‚úÖ Stable au reload : si on a d√©j√† choisi pour cette heure, on r√©utilise
      const cachedKey = getCachedPickKey(now, SALT);
      const cached = findByKey(activeSurprises, cachedKey);
      if (cached) return cached;

      const p = pickHourlyWeightedNoRepeat(activeSurprises, now, SALT);
      if (p?.key) {
        setCachedPickKey(now, SALT, p.key);
        saveToHistoryOncePerHour(now, SALT, p.key);
      }
      return p;
    })();

    if (isDev()) {
    const slot = getSpecialSlotDebug(now);
    console.log("DEV slot actif:", slot ? slot.key : "aucun");
    if (!item || !item.key) console.warn("‚ö†Ô∏è Surprise sans key :", item);
    }

    renderPage(item, now);
}

init();
</script>
</body>
</html>
